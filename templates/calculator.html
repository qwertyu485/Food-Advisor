{% extends "base.html" %}

{% block title %}FoodAdvisor - Calculator{% endblock %}

{% block page_title %}
<div class="page-title">
    <h1>Meal Calculator</h1>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="calculator-container">
        <div class="card">
            <h2 style="font-family: 'Outfit', sans-serif; font-size: 22px; margin-bottom: 20px;">Add Food to Meal</h2>
            
            <div class="form-group">
                <label for="food-input">Food Name</label>
                <input type="text" id="food-input" class="form-control" placeholder="Search for a food...">
            </div>
            
            <div class="form-group">
                <label for="amount-input">Amount (grams)</label>
                <input type="number" id="amount-input" class="form-control" placeholder="100" value="100" min="1">
            </div>
            
            <button id="add-food-btn" class="btn btn-primary" style="width: 100%;">
                Add to Meal
            </button>
            
            <div id="search-results" style="margin-top: 16px;"></div>
        </div>
        
        <div class="card">
            <h2 style="font-family: 'Outfit', sans-serif; font-size: 22px; margin-bottom: 20px;">Your Meal</h2>
            
            <div id="meal-items">
                <div class="empty-state" style="padding: 20px;">
                    <p>No items added yet</p>
                </div>
            </div>
            
            <div id="inputs-summary" style="display: none; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-top: 16px;">
                <p id="inputs-summary-text" style="font-size: 14px; color: #374151; margin-bottom: 12px;"></p>
                <div style="background: white; border-radius: 6px; padding: 12px;">
                    <h5 style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Ingredients in your meal</h5>
                    <div id="inputs-itemized-list"></div>
                </div>
            </div>
            
            <div id="meal-totals" class="total-section" style="display: none;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Total nutrition for this meal:</h3>
                <div class="total-row">
                    <span>Calories</span>
                    <span id="total-calories">0 kcal</span>
                </div>
                <div class="total-row">
                    <span>Protein</span>
                    <span id="total-protein">0 g</span>
                </div>
                <div class="total-row">
                    <span>Fat</span>
                    <span id="total-fat">0 g</span>
                </div>
                <div class="total-row">
                    <span>Carbs</span>
                    <span id="total-carbs">0 g</span>
                </div>
                <div class="total-row">
                    <span>Fiber</span>
                    <span id="total-fiber">0 g</span>
                </div>
                <div class="total-row">
                    <span>Sugar</span>
                    <span id="total-sugar">0 g</span>
                </div>
            </div>
            
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button id="calculate-btn" class="btn btn-primary" style="flex: 1;">
                    Calculate Total Nutrition
                </button>
                <button id="clear-meal-btn" class="btn btn-secondary" style="flex: 1;">
                    Clear Meal
                </button>
            </div>
            <div id="save-status" style="display: none; margin-top: 12px; padding: 10px; border-radius: 6px; text-align: center;"></div>
        </div>
    </div>
</div>

<script>
let mealItems = [];
let mealSaved = false;

document.getElementById('add-food-btn').addEventListener('click', searchAndAddFood);
document.getElementById('food-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchAndAddFood();
});
document.getElementById('calculate-btn').addEventListener('click', calculateAndSave);
document.getElementById('clear-meal-btn').addEventListener('click', clearMeal);

async function searchAndAddFood() {
    const query = document.getElementById('food-input').value.trim();
    const amount = parseInt(document.getElementById('amount-input').value) || 100;
    
    if (!query) return;
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<p style="color: #666; text-align: center;">Searching...</p>';
    
    try {
        const response = await fetch(`/api/foods/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.foods && data.foods.length > 0) {
            const food = data.foods[0];
            addFoodToMeal(food, amount);
            document.getElementById('food-input').value = '';
            resultsDiv.innerHTML = `<p style="color: #065f46; text-align: center;">Added: ${food.description}</p>`;
            setTimeout(() => resultsDiv.innerHTML = '', 2000);
        } else {
            resultsDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Food not found</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Error searching</p>';
    }
}

function addFoodToMeal(food, amount) {
    const nutrients = food.foodNutrients || [];
    const scale = amount / 100;
    
    const getNutrient = (name) => {
        const n = nutrients.find(n => n.nutrientName === name);
        return n ? n.value * scale : 0;
    };
    
    mealItems.push({
        name: food.description,
        amount: amount,
        calories: getNutrient('Energy'),
        protein: getNutrient('Protein'),
        fat: getNutrient('Total lipid (fat)'),
        carbs: getNutrient('Carbohydrate, by difference'),
        fiber: getNutrient('Fiber, total dietary'),
        sugar: getNutrient('Sugars, total including NLEA')
    });
    
    mealSaved = false;
    updateMealDisplay();
}

function removeFoodItem(index) {
    mealItems.splice(index, 1);
    mealSaved = false;
    updateMealDisplay();
}

function updateMealDisplay() {
    const itemsDiv = document.getElementById('meal-items');
    const totalsDiv = document.getElementById('meal-totals');
    const inputsSummaryDiv = document.getElementById('inputs-summary');
    const inputsSummaryText = document.getElementById('inputs-summary-text');
    const inputsItemizedList = document.getElementById('inputs-itemized-list');
    
    if (mealItems.length === 0) {
        itemsDiv.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No items added yet</p></div>';
        totalsDiv.style.display = 'none';
        inputsSummaryDiv.style.display = 'none';
        document.getElementById('save-status').style.display = 'none';
        return;
    }
    
    itemsDiv.innerHTML = mealItems.map((item, index) => `
        <div class="meal-item">
            <div class="meal-item-info">
                <div class="meal-item-name">${item.name}</div>
                <div class="meal-item-amount">${item.amount}g - ${Math.round(item.calories)} kcal</div>
            </div>
            <button class="meal-item-remove" onclick="removeFoodItem(${index})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
    `).join('');
    
    inputsSummaryDiv.style.display = 'none';
    totalsDiv.style.display = 'none';
}

function showTotals() {
    const inputsSummaryDiv = document.getElementById('inputs-summary');
    const inputsSummaryText = document.getElementById('inputs-summary-text');
    const inputsItemizedList = document.getElementById('inputs-itemized-list');
    const totalsDiv = document.getElementById('meal-totals');
    
    const inputsSummary = mealItems.map(item => `${item.name} (${item.amount}g)`).join(', ');
    inputsSummaryText.innerHTML = `<strong>Your nutrition summary for:</strong> ${inputsSummary}`;
    
    inputsItemizedList.innerHTML = mealItems.map(item => `
        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e5e7eb;">
            <span>${item.name}</span>
            <span style="color: #666;">${item.amount}g</span>
        </div>
    `).join('');
    
    const totals = mealItems.reduce((acc, item) => ({
        calories: acc.calories + item.calories,
        protein: acc.protein + item.protein,
        fat: acc.fat + item.fat,
        carbs: acc.carbs + item.carbs,
        fiber: acc.fiber + item.fiber,
        sugar: acc.sugar + item.sugar
    }), { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, sugar: 0 });
    
    document.getElementById('total-calories').textContent = Math.round(totals.calories) + ' kcal';
    document.getElementById('total-protein').textContent = Math.round(totals.protein) + ' g';
    document.getElementById('total-fat').textContent = Math.round(totals.fat) + ' g';
    document.getElementById('total-carbs').textContent = Math.round(totals.carbs) + ' g';
    document.getElementById('total-fiber').textContent = Math.round(totals.fiber) + ' g';
    document.getElementById('total-sugar').textContent = Math.round(totals.sugar) + ' g';
    
    inputsSummaryDiv.style.display = 'block';
    totalsDiv.style.display = 'block';
}

async function calculateAndSave() {
    if (mealItems.length === 0) {
        const statusDiv = document.getElementById('save-status');
        statusDiv.innerHTML = '<span style="color: #dc2626;">Add foods to your meal first</span>';
        statusDiv.style.background = '#fef2f2';
        statusDiv.style.display = 'block';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);
        return;
    }
    
    showTotals();
    
    if (mealSaved) {
        const statusDiv = document.getElementById('save-status');
        statusDiv.innerHTML = '<span style="color: #065f46;">Totals updated (already saved to history)</span>';
        statusDiv.style.background = '#ecfdf5';
        statusDiv.style.display = 'block';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);
        return;
    }
    
    const totals = mealItems.reduce((acc, item) => ({
        calories: acc.calories + item.calories,
        protein: acc.protein + item.protein,
        fat: acc.fat + item.fat,
        carbs: acc.carbs + item.carbs,
        fiber: acc.fiber + item.fiber,
        sugar: acc.sugar + item.sugar
    }), { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, sugar: 0 });
    
    const payload = {
        items: mealItems.map(item => ({
            name: item.name,
            amount: item.amount,
            calories: Math.round(item.calories),
            protein: Math.round(item.protein),
            fat: Math.round(item.fat),
            carbs: Math.round(item.carbs)
        })),
        totals: {
            calories: Math.round(totals.calories),
            protein: Math.round(totals.protein),
            fat: Math.round(totals.fat),
            carbs: Math.round(totals.carbs),
            fiber: Math.round(totals.fiber),
            sugar: Math.round(totals.sugar)
        }
    };
    
    try {
        const response = await fetch('/api/history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'calculator', payload: payload })
        });
        
        if (response.ok) {
            mealSaved = true;
            const statusDiv = document.getElementById('save-status');
            statusDiv.innerHTML = '<span style="color: #065f46;">Saved to history</span>';
            statusDiv.style.background = '#ecfdf5';
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);
        }
    } catch (error) {
        console.error('Save failed:', error);
        const statusDiv = document.getElementById('save-status');
        statusDiv.innerHTML = '<span style="color: #dc2626;">Failed to save</span>';
        statusDiv.style.background = '#fef2f2';
        statusDiv.style.display = 'block';
    }
}

function clearMeal() {
    if (mealItems.length === 0 || confirm('Are you sure you want to clear your meal?')) {
        mealItems = [];
        mealSaved = false;
        updateMealDisplay();
        document.getElementById('save-status').style.display = 'none';
    }
}
</script>
{% endblock %}
