{% extends "base.html" %}

{% block title %}FoodAdvisor - History{% endblock %}

{% block page_title %}
<div class="page-title">
    <h1>Your History</h1>
</div>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px;">
    <div class="card" style="margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-family: 'Outfit', sans-serif; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Your Search History
            </h2>
            <button onclick="clearHistory('search')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                Clear Search History
            </button>
        </div>
        
        <div id="search-history-container">
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <p style="font-size: 16px; font-weight: 500;">Loading...</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-family: 'Outfit', sans-serif; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
                Meal Calculator History
            </h2>
            <button onclick="clearHistory('calculator')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                Clear Meal History
            </button>
        </div>
        
        <div id="calculator-history-container">
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/></svg>
                <p style="font-size: 16px; font-weight: 500;">Loading...</p>
            </div>
        </div>
    </div>
</div>

<script>
async function loadHistory() {
    try {
        const response = await fetch('/api/history');
        const data = await response.json();
        
        renderSearchHistory(data.search || []);
        renderCalculatorHistory(data.calculator || []);
    } catch (error) {
        console.error('Failed to load history:', error);
        document.getElementById('search-history-container').innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading history</p>';
        document.getElementById('calculator-history-container').innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading history</p>';
    }
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function renderSearchHistory(items) {
    const container = document.getElementById('search-history-container');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <p style="font-size: 16px; font-weight: 500;">No search history yet</p>
                <p style="font-size: 14px; margin-top: 8px;">Your food searches will appear here.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = items.map((item, index) => {
        const payload = item.payload;
        const query = payload.query || 'Unknown';
        const resultCount = (payload.results || []).length;
        
        return `
            <div class="history-accordion" data-id="${item.id}">
                <div class="history-header" onclick="toggleSearchAccordion(this, ${index})">
                    <div>
                        <span style="font-weight: 500;">${query}</span>
                        <span style="font-size: 12px; color: #666; margin-left: 8px; background: #eff6ff; padding: 2px 8px; border-radius: 4px;">${resultCount} result${resultCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; color: #999;">${formatDate(item.created_at)}</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg>
                    </div>
                </div>
                <div class="history-content" id="search-content-${index}">
                    ${renderSearchPayload(payload)}
                </div>
            </div>
        `;
    }).join('');
}

function renderSearchPayload(payload) {
    const results = payload.results || [];
    
    if (results.length === 0) {
        return `
            <div style="padding: 16px;">
                <p style="color: #666;">Searched for: <strong>${payload.query}</strong></p>
                <p style="color: #999; font-size: 13px; margin-top: 8px;">No saved results for this search.</p>
            </div>
        `;
    }
    
    return `
        <div style="padding: 16px;">
            <p style="color: #666; margin-bottom: 16px;">Results for: <strong>${payload.query}</strong></p>
            ${results.map(food => `
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">${food.description}</h4>
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">${food.brandOwner}</p>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; text-align: center;">
                        <div style="background: #f0fdf4; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #059669; font-size: 13px;">${food.calories}</div>
                            <div style="font-size: 9px; color: #666;">kcal</div>
                        </div>
                        <div style="background: #eff6ff; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #2563eb; font-size: 13px;">${food.protein}g</div>
                            <div style="font-size: 9px; color: #666;">Protein</div>
                        </div>
                        <div style="background: #fef3c7; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #d97706; font-size: 13px;">${food.fat}g</div>
                            <div style="font-size: 9px; color: #666;">Fat</div>
                        </div>
                        <div style="background: #fce7f3; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #db2777; font-size: 13px;">${food.carbs}g</div>
                            <div style="font-size: 9px; color: #666;">Carbs</div>
                        </div>
                        <div style="background: #ecfdf5; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #065f46; font-size: 13px;">${food.fiber}g</div>
                            <div style="font-size: 9px; color: #666;">Fiber</div>
                        </div>
                        <div style="background: #fdf2f8; padding: 6px 4px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #be185d; font-size: 13px;">${food.sugar}g</div>
                            <div style="font-size: 9px; color: #666;">Sugar</div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderCalculatorHistory(items) {
    const container = document.getElementById('calculator-history-container');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/></svg>
                <p style="font-size: 16px; font-weight: 500;">No meal calculations yet</p>
                <p style="font-size: 14px; margin-top: 8px;">Your saved meals from the calculator will appear here.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = items.map((item, index) => {
        const payload = item.payload;
        const itemCount = (payload.items || []).length;
        const totalCals = payload.totals?.calories || 0;
        
        return `
            <div class="history-accordion" data-id="${item.id}">
                <div class="history-header" onclick="toggleCalcAccordion(this, ${index})">
                    <div>
                        <span style="font-weight: 500;">${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
                        <span style="font-size: 14px; color: #059669; margin-left: 8px;">${totalCals} kcal</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; color: #999;">${formatDate(item.created_at)}</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg>
                    </div>
                </div>
                <div class="history-content" id="calc-content-${index}">
                    <div style="padding: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Meal Items:</h5>
                        ${(payload.items || []).map(it => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span>${it.name}</span>
                                <span style="color: #666;">${it.amount}g - ${it.calories} kcal</span>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #065f46;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #065f46;">Total Nutrition:</h5>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.calories || 0}</div>
                                    <div style="font-size: 12px; color: #666;">Calories</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.protein || 0}g</div>
                                    <div style="font-size: 12px; color: #666;">Protein</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.fat || 0}g</div>
                                    <div style="font-size: 12px; color: #666;">Fat</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.carbs || 0}g</div>
                                    <div style="font-size: 12px; color: #666;">Carbs</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.fiber || 0}g</div>
                                    <div style="font-size: 12px; color: #666;">Fiber</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${payload.totals?.sugar || 0}g</div>
                                    <div style="font-size: 12px; color: #666;">Sugar</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleSearchAccordion(header, index) {
    const content = document.getElementById(`search-content-${index}`);
    const isOpen = content.classList.contains('open');
    
    document.querySelectorAll('.history-content').forEach(c => c.classList.remove('open'));
    
    if (!isOpen) {
        content.classList.add('open');
    }
}

function toggleCalcAccordion(header, index) {
    const content = document.getElementById(`calc-content-${index}`);
    const isOpen = content.classList.contains('open');
    
    document.querySelectorAll('.history-content').forEach(c => c.classList.remove('open'));
    
    if (!isOpen) {
        content.classList.add('open');
    }
}

async function clearHistory(type) {
    const typeName = type === 'search' ? 'search' : 'meal calculator';
    if (!confirm(`Are you sure you want to clear your ${typeName} history?`)) return;
    
    try {
        await fetch('/api/history/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type })
        });
        loadHistory();
    } catch (error) {
        console.error('Failed to clear history:', error);
    }
}

loadHistory();
</script>
{% endblock %}
